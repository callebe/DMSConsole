\label{section:ControladorDosPaineis}
Para que a aplicação DMSConsole seja capaz de gerenciar a rede de painéis eletrônicos conectados ao console, e ainda atender as requisições feitas através da interface de usuário, é desenvolvida a biblioteca DMSDisplay.  Esta biblioteca contém as funções capazes de efetuar o reconhecimento e configurações dos dispositivos da rede de indicadores de destino. Para tal esta biblioteca se utiliza de uma interface de comunicação serial emulada e dois \textit{timers} do sistema Linux. Estes \textit{timers}  são uteis para realizar algumas rotinas de configurações e manter o procedimento cíclico de atualização dos painéis. 

O gerenciamento dos painéis é feito através do envio e recepção de mensagens usando o protocolo de comunicação LDESIGN. O console é um dispositivo \textit{Master} que realiza as requisições aos painéis, com mensagens console-painéis, e os painéis respondem com mensagens painel-console.  O DMSConsole deve enviar e receber tais mensagens, mediante a requisição do usuário e/ou as necessidade que as rotinas de configurações exigem. Dentro do LDESIGN existe uma conjunto de tipos de mensagens, sendo que para para cada tipo é desenvolvido dentro da biblioteca DMSDisplay uma função C++ para executar a transmissão ou recepção dos dados. As subseções a seguir apresentam os tipos de mensagem deste protocolo, definindo o valor para os campos 'Tipo' e 'Dados',  e especificando a funcionalidade de cada mensagem para o DMSConsole. 

\subsubsection{MSG Network Config}
\label{subsection:MensageConsolePanel}
Esta mensagem realiza o reconhecimento dos dispositivos conectados a rede de painéis eletrônicos. Esta mensagem é transmitida pelo console em \textit{broadcast} usando o endereço 0xFF a todos os painéis, os quais respondem a requisição com uma mensagem 'Painel ID'(\ref{sec:PainelID}), em sequência de acordo com o seu ID. O byte 'Tipo' desta mensagem é definido como 0x22, 'N' é igual a 2, e não existem bytes a serem enviados no campo 'Dados'. Ao final de cada Painel ID ainda é enviado um byte 'ACK' ou 'NACK' de reconhecimento.

Quando o DMSConsole é iniciado ele realiza uma rotina que envia uma mensagem \textit{MSG Network Config} a todos os painéis via \textit{broadcast}, de modo a detectar o número e as configurações dos painéis ligados a rede de indicadores de destino. Se nenhum painel for detectado se faz necessário informar ao usuário tal informação, caso contrário o usuário só será informado do número ou configurações dos painéis quando for necessário criar um arquivo de fonte de dados pelo editor do DMSConsole.

\subsubsection{MSG Define Brightness}
Através desta mensagem é possível configurar o nível de brilho de cada painel. Esta mensagem é enviada pelo console e pode ser endereçada para um painel específico, ou enviada por \textit{broadcast} via endereço 0xFF. O byte 'Tipo' desta mensagem é 0x26, e 'N' é igual 2. O comando 'Dados' é definido como 1 byte em ASCII que representam a intensidade do brilho a ser utilizado no painel, sendo definido:

\begin{itemize}
	\item '1' Nível 1 de Brilho
	\item '2' Nível 2 de Brilho
	\item '3' Nível 3 de Brilho
	\item '4' Nível 4 de Brilho
	\item '5' Nível 5 de Brilho
	\item '6' Nível 5 de Brilho
	\item 'A' Nível Automático 
\end{itemize}

Em resposta a esta mensagem o painel deve enviar uma mensagem 'ACK' em caso reconhecer e validar a mensagem, ou caso contrário deve ser enviado  uma mensagem 'NACK'. O DMSConsole deve enviar está mensagem apenas quando o usuário acender a Página de Configuração dos Painéis e selecionar um nível de brilho diferente do atual. 

\subsubsection{MSG Reset}
Esta mensagem destina-se a realização de limpeza na memória dos painéis eletrônicos, colocando estes no estado de arranque. O byte tipo desta mensagem é definido como 0x1A, o byte 'N' é 1, não existe bytes a serem enviados no campo 'Dados'. Esta mensagem é enviada pelo console, sendo destinada a todos os painéis, via transmissão \textit{broadcast}. Após o envio desta mensagem o painel deve responder com uma mensagem 'ACK' se este reconhecer a mensagem, caso contrário ele deve mandar uma mensagem 'NACK'. Esta mensagem só é enviado pelo DMSConsole quando o usuário acende a Página de Configuração dos Painéis é seleciona a opção 'Reset'.

\subsubsection{MSG INFO}
Esta mensagem é enviada pelo console e contém dados que descrevem as informações a serem afixadas em um painel específico. Esta mensagem é enviada individualmente para cada painel. O byte 'Tipo' desta mensagem é definido como 0x21, e o Byte 'N' é variável de acordo com o número total de bytes presentes nessa mensagem. O campos 'Dados' segue uma estrutura geral descrita abaixo:

\vspace{5mm}
\begin{table}[H]
	\centering
	\captionsetup{width=0.8\linewidth}
	\begin{tabular}{|c|c|l|c|}
		\hline
		\cellcolor[HTML]{000000}{\color[HTML]{FFFFFF}Ordem} & \cellcolor[HTML]{000000}{\color[HTML]{FFFFFF}Comando} & \cellcolor[HTML]{000000}{\color[HTML]{FFFFFF}Descrição} & \cellcolor[HTML]{000000}{\color[HTML]{FFFFFF}Nº Bytes} \\
		\hline
		1º     & Index              & Contador de Referência   & 1      \\
		\hline
		2º     & Page General Info  & Informações gerais sobre as   & 3      \\
		&                    & páginas a seguir              &        \\
		\hline
		3º     & Stream ID          & Define se a mensagem é BITMAP & 1      \\
		&                    & ou ASCII                      & 1      \\
		\hline
		4º     & Page Info 1        & Descrição da Pagina 1  & N   \\
		\hline
		5º     & Page Info 2        & Descrição da Pagina 2 (Opcional) & N   \\
		\hline
		6º     & Page Info 3        & Descrição da Pagina 3 (Opcional) &  N   \\
		\hline
		7º     & \textless{}END\textgreater{} & \textit{End of Message} - 23h    & 1    \\
		\hline
	\end{tabular}
	\caption{Formato Geral - MSG Info}
	\vspace{-3.5mm}
	\caption*{Fonte: \citeonline{DMSManual}}
	\label{tab:GeralMSG_INFO}
\end{table}
\vspace{5mm}

Cada painel possui um contador \textit{TimeOut} que cronometra o tempo decorrido desde a última mensagem MSG INFO enviada. Quando este contador atingi o valor de 2 minutos o painel apaga as informações fixadas. Assim, no DMSConsole deve haver uma rotina que, no máximo a cada 2 minutos, reenvia automaticamente mensagens do tipo MSG INFO a todos os painéis da rede, mesmo que estas mensagens sejam iguais as últimas mensagens enviadas. Para que o \textit{firmware} dos painéis não precise apagar e reescrever os dados fixados toda a vez em que mensagens tipo MSG INFO exatamente iguais são enviadas, com o intuito de evitar que o contator \textit{TimeOut} estoure, o primeiro Byte da mensagem, o 'Index', somente é incrementado quando a mensagem a ser enviada é diferente da anterior.

O comando 'Page Geral Info' é o conjunto de 3 bytes que descrevem as informações a cerca das páginas a serem fixadas no painel de destino, a Figura (\ref{fig:PageGeneralInfoMSG_INFO}) apresenta a descrição deste bytes na ordem MSB  (\textit{Most Significant Bit}).

\vspace{9mm}
\begin{figure}[H]
	\centering
	\captionsetup{width=\textwidth, font=footnotesize, textfont=bf}	
	\includegraphics[width=\linewidth]{Images/SoftwareDMSConsole/PageGeneralInfoMSG_INFO.eps}
	\caption{MSG Info - Page General Info}
	\vspace{-3.5mm}
	\caption*{Fonte: \citeonline{DMSManual}}
	\label{fig:PageGeneralInfoMSG_INFO}
\end{figure} 
\vspace{9mm}

O comando 'STREAM ID' tem dois formato diferentes, quando a mensagem é no sentido painel-console 'STREAM ID' é composto com 1 byte ASCII com o caractere 'A' quando a informação é no formato ASCII, ou 'B' quando é no formato BITMAP. Já se a mensagem é no sentido console-painel o comando 'STREAM ID' é composto por 5 bytes, se estes bytes forem preenchidos corretamente com a sequência de caracteres 'ASCII' a mensagem é classificada como  ASCII, ou caso contrário ela é classificada como BITMAP.

O comando 'Page Info' descreve as informações a serem visualizadas nos painéis, sendo estas informações dividias por páginas, as quais podem possuir o número da linha e até 3 campos de texto. Em um painel é permitido de 1 á 3 paginas, sendo obrigatório haver ao menos uma página. A estrutura do comando 'Page Info' é descrita na Tabela \ref{tab:PageInfoMSG_INFO}.

\vspace{5mm}
\begin{table}[H]
	\centering
	\captionsetup{width=0.8\linewidth}
	\begin{tabular}{|c|c|l|c|}
		\hline
		\cellcolor[HTML]{000000}{\color[HTML]{FFFFFF}Ordem} & \cellcolor[HTML]{000000}{\color[HTML]{FFFFFF}Comando} & \cellcolor[HTML]{000000}{\color[HTML]{FFFFFF}Descrição} & \cellcolor[HTML]{000000}{\color[HTML]{FFFFFF}Nº Bytes} \\
		\hline
		1º     & Page Header   & Cabeçalho de definição das informações sobre a & 3   \\
		&               & página                                         &     \\
		\hline
		2º     & Bus Line      & Conjunto de Bytes em ASCII que representam o   & N   \\
		&               & número da Linha                                &     \\
		\hline
		3º     & Info Line 1   & Conjunto de Bytes em ASCII que representam o   & N   \\
		&               & texto 1 a ser afixado  (Opcional)              &     \\
		\hline
		4º     & \textless CR \textgreater \textless LF\textgreater  & Separadores de blocos Page Info - 0x0D 0x0A    & 2   \\
		&               & (Opicional)                                    &     \\
		\hline
		5º     & Info Line 2   & Conjunto de Bytes em ASCII que representam o   & N   \\
		&               & texto 2 a ser afixado  (Opcional)              &     \\
		\hline
		6º     & \textless CR \textgreater \textless LF\textgreater  & Separadores de blocos Page Info - 0x0D 0x0A    & 2   \\
		&               & (Opicional)                                    &     \\
		\hline
		7º     & Info Line 3   & Conjunto de Bytes em ASCII que representam o   & N   \\
		&               & texto 3 a ser afixado  (Opcional)              &     \\
		\hline
	\end{tabular}
	\caption{Formato Page Info - MSG Info}
	\vspace{-3.5mm}
	\caption*{Fonte: \citeonline{DMSManual}}
	\label{tab:PageInfoMSG_INFO}
\end{table}
\vspace{5mm}

O 'Page Header' é o cabeçalho que descreve cada página a ser transmitida, sendo que este comando possui apenas 3 bytes, a serem preenchidos na seguinte forma:

\vspace{9mm}
\begin{figure}[H]
	\centering
	\captionsetup{width=\textwidth, font=footnotesize, textfont=bf}	
	\includegraphics[width=\linewidth]{Images/SoftwareDMSConsole/PageInfo_Header.eps}
	\caption{MSG Info - Page Info Header}
	\vspace{-3.5mm}
	\caption*{Fonte: \citeonline{DMSManual}}
	\label{fig:PageInfo_Header}
\end{figure} 
\vspace{9mm}

Onde:

\begin{itemize}
	\item \textbf{Nº Linhas :} Número de campos de texto na página, de 0 a 3 páginas.
	\item \textbf{Info Visual :} Formato das informações a serem exibidas, sendo as opções:
	\subitem 00 - Apenas o número da linha
	\subitem 01 - Apenas os campos de Texto
	\subitem 10 - O número da linha e os campos de texto
	\subitem 11 - Nenhuma informação
	\item \textbf{Alinha. Número / Alinha. Texto 1,2 e 3 :} Alinhamento do número da linha e dos campos de texto, sendo as opções para cada elemento:
	\subitem 00 - Esquerda
	\subitem 01 - Centro
	\subitem 10 - Direita
	\subitem 11 - Não identificado
	\item \textbf{Efeito Número / Efeito Texto 1,2 e 3 :} Efeito a ser aplicado no número da linha e nos campos de texto, sendo as opções para cada elemento:
	\subitem 000 - Sem efeito
	\subitem 001 - Piscar
	\subitem 010 - Rodar
	\subitem 011 - Não definido
	\item \textbf{ID Fonte Número / ID Fonte Texto 1, 2 e 3 :} Tamanho da fonte a ser aplicada no número da linha e nos campos de texto. Estas fontes são carregadas no Firmware dos painéis e podem mudar de acordo com a versão do painel. Na maioria dos modelos de painéis eletrônicos da DMS as opções de fonte são:
	\subitem 0x00 - 5x5
	\subitem 0x01 - 7x5
	\subitem 0x02 - 8x6
	\subitem 0x03 - 11x7
	\subitem 0x04 - 12x7
	\subitem 0x05 - 13x9
	\subitem 0x06 - 14x9
	\subitem 0x07 - 15x9
	\subitem 0x08 - 16x9
	\subitem 0x09 - 17x11
	\subitem 0x10 - 19x11
	
\end{itemize}

O comando 'Page Info' deve ser seguido pelo comando 'Bus Line', o qual nada mais é do que o conjunto de caracteres ASCII que representam o número da linha. Deve-se observar que o número de bytes 'Bus Line' deve ser o mesmo já definido em  'Page Header'. Após o comando 'Bus Line' se existir o campos de texto 1 é necessário enviar o conjunto de caracteres ASCII que representam a mensagem do texto 1, observando que o limite de 29 caracteres. Se existir um texto 2 é necessário enviar o comando \textless CR \textgreater \textless LF\textgreater  para separar os blocos, o mesmo deve ocorrer com o texto 3. Após o envio do MSG Info o painel alvo da mensagem deve enviar um comando 'ACK', se este reconhecer a mensagem e a validar, se não ele envia um comando 'NACK'.

\subsubsection{MSG Panel Test}
Esta mensagem destina-se a realização de testes básicos nos painéis. Esta mensagem pode ser endereçada a um painel ou enviada em \textit{broadcast} via endereço 0xFF a todos os painéis da rede. O comando 'Tipo' desta mensagem é definido como 0x40, e 'N' é igual a 2. O comando 'Dados' desta mensagem define qual tipo de teste será realizado, sendo sa seguinte forma:

\begin{itemize}
	\item 0x01 - Teste de RAM e FLASH
	\item 0x02 - Teste de varrimento vertical de LEDs
	\item 0x03 - Teste de varrimento horizontal de LEDS
\end{itemize}

O DMSConsole envia este tipo de mensagem quando o usuário acessa a Página de Configuração dos Painéis e seleciona uma opção de teste. Se o teste escolhido for o teste de varrimento horizontal ou vertical de LEDs, todos os painéis da rede ao receberem esta mensagem executam a rotina de apagar todos os LEDs e acender apenas uma linha, no caso horizontal, ou uma coluna, no caso vertical, por vez varrendo todos os LEDs. Ao final todos os painéis devem manter todos os seus LEDs acesos com brilho nível 2 até receberem novas mensagens. 

Já no caso de um teste de memória RAM e Flash, todos os painéis da rede ao receberem esta mensagem passam a checar suas memórias, e cada uma envia sequencialmente uma mensagem ACK caso o teste ocorra com sucesso, ou NACK caso tenham encontrado algum problema durante o teste. 

\subsubsection{ACK e NACK}

Esta mensagem é enviada por um painel em resposta a requisição realizada pelo console. A mensagem ACK ou \textit{acknowledge} informa ao console que a mensagem recebida foi reconhecida e validada. Já a mensagem NACK ou  \textit{not acknowledge} informa ao console que a mensagem recebida não foi reconhecida. A mensagem 'ACK' tem o campo 'Tipo' definido por 0x86 e 'N'  definido por 2. Já a mensagem 'NACK' tem 'Tipo' igual a 0x95 e também 'N' igual a 2. Ambos as mensagens não possuem informação 'Dados'.     

\subsubsection{Panel ID}
\label{sec:PainelID}
Esta mensagem é enviada por uma painel em resposta a uma mensagem MSG Network Config \ref{subsection:MensageConsolePanel}. Através desta mensagem o console identificar as configurações físicas dos painéis conectados a rede. O comando 'Tipo' desta mensagem é definido como 0x61 e 'N' é igual a 5. O comando 'Dados' desta mensagem é constituída da seguinte forma:

\vspace{5mm}
\begin{table}[H]
	\centering
	\captionsetup{width=\linewidth}
	\begin{tabular}{|c|c|l|c|}
		\hline
		\cellcolor[HTML]{000000}{\color[HTML]{FFFFFF}Ordem} & \cellcolor[HTML]{000000}{\color[HTML]{FFFFFF}Comando} & \cellcolor[HTML]{000000}{\color[HTML]{FFFFFF}Descrição} & \cellcolor[HTML]{000000}{\color[HTML]{FFFFFF}Nº bits} \\
		\hline
		1º     & Endereço  & Endereço do painel na rede                   & 1  \\
		\hline
		2º     & Linhas    & Número de linhas físicas de LED  do painel   & 1  \\
		\hline
		3º     & Colunas   & Número de colunas físicas de LED  do painel  & 1 \\
		\hline
		4º     & Aux       & Define se o painel suporta destinos alternativos  & 1 \\
		\hline
	\end{tabular}
	\caption{Formato Panel ID}
	\caption*{Fonte: \citeonline{DMSManual}}
	\label{tab:PanelID}
\end{table}
\vspace{5mm}