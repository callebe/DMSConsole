\label{cap:MontagemConsole}
Neste etapa é desenvolvido o \textit{hardware} para o novo console, o qual deve suportar o \textit{software} desenvolvido no capitulo (\real{cap:DesenvolvimentoAplicacao}). O novo console de indicadores de destino da DMS tem a necessidade de ser alocado dentro do painel dos autocarros, em uma disposição muito parecida com a que o modelo SICON II ocupava. Nesta disposição o novo console deve estar montado dentro de uma caixa suporte com dimensões precisas, e com os conectores de comunicação e alimentação alinhados, da mesma forma que o modelo antigo. Como o projeto da caixa suporte não esta dentro do escopo deste trabalho, o departamento de desenvolvimento da DMS disponibilizou uma caixa suporte de plastico para o módulo \textit{Display Touchscreen} que atende a todas os requisitos de dimensões e de localização dos conectores. 

\section{Desenvolvimento da Placa de Integração}

Para montar o novo console dentro do suporte em um produto final é necessário projetar uma placa de circuito impresso que faça a integração entre o Raspberry Pi Zero W, os conversores UART (TTL/ RS232) e UART (TTL/ RS485) e uma fonte de tensão de 5V. Um autocarro tipicamente possui tomadas de tensão na faixa dos 24V, na região do painel do motorista. Porém deve se ter cuidado com o fato de que esta tensão é provida pela bateria do autocarro, que por sua vez é alimentada pelo alternador. Segundo \citeonline{DMSManual}, devido a dinâmica de carga e descarga da bateria alimentada pelo alternador do autocarro, é comum as tomadas de 24V apresentarem variações de tensão de até $\pm 10 V$. Os conversores UART e o Raspberry devem ser alimentados a uma Tensão de 5V, sendo estes dispositivos sensíveis a grandes variações de tensão. Logo a fonte de tensão empregada deve ser um conversor de tensão capaz de absorver as grandes variações, sendo de preferência um conversor CC-CC chaveado, para obter um alto rendimento.

A DMS utiliza o circuito integrado OKI-78SR5, que é um regulador de tensão CC-CC chaveado não isolado, em seus projetos de fontes de alimentação para sistemas embarcados. Este CI pode operar com 7 á 36 V de entrada, mantendo a tensão de saída em 5V com uma oscilação de $\pm$1V, logo atendendo a necessidade deste projeto \cite{oki}. A Figura (\ref{fig:EsquematicoConversorCC-CC}) apresenta o esquemático  do regulador de tensão a ser usado na placa de integração. Este esquemático foi feito no \textit{software Altium$^{\textregistered}$}, cedido pela DMS para a realização deste trabalho.

\vspace{9mm}
\begin{figure}[H]
	\centering
	\captionsetup{width=0.9\textwidth, font=footnotesize, textfont=bf}	
	\includegraphics[width=0.9\linewidth]{Images/MontagemConsole/EsquematicoConversorCC_CC.eps}
	\caption{Esquemático do Conversor CC-CC}
	\vspace{-3.5mm}
	\caption*{Fonte: Autoria Própria}
	\label{fig:EsquematicoConversorCC-CC}
\end{figure} 
\vspace{9mm}       

No esquemático da Figura (\ref{fig:EsquematicoConversorCC-CC}) há um conector de 8 pinos para a tensão de entrada do regulador de tensão, mesmo havendo a necessidade de apenas dois conectores. Isso acontece por uma questão de padronização e disponibilidade de conectores da DMS. Pois esta placa de circuito impresso será montada pelo departamento de produção da DMS, e portanto esta sujeita a limitação de disponibilidade de componentes.

Na mesma folha de projeto do regulador de tensão é feito o esquemático do conversor UART-RS232 e do conversor UART-RS485. Tais esquemáticos obedecem aos requisitos de projeto apresentados nas folhas de informações técnicas dos respectivos componentes; \citeonline{232} e \citeonline{485}. As Figuras (\ref{fig:EsquematicoConversorTTL-RS232}), (\ref{fig:EsquematicoConversorTTL-RS485}) e (\ref{fig:EsquematicoRaspberry}) apresentam respectivamente os esquemáticos do conversor UART RS232, conversor UART 485 e do conector para Raspberry Pi. O conector presente no esquemático da Figura (\ref{fig:EsquematicoRaspberry}) é um conector fêmea 20x2 pinos, adequado para o encaixe sobre os pinos da GPIO do Raspberry Pi Zero W com pinos macho.


\vspace{9mm}
\begin{figure}[H]
	\centering
	\captionsetup{width=0.9\textwidth, font=footnotesize, textfont=bf}	
	\includegraphics[width=0.9\linewidth]{Images/MontagemConsole/EsquematicoConversorTTL-RS232.eps}
	\caption{Esquemático do Conversor UART TTL / UART RS232}
	\vspace{-3.5mm}
	\caption*{Fonte: Autoria Própria}
	\label{fig:EsquematicoConversorTTL-RS232}
\end{figure} 
\vspace{9mm}

\vspace{9mm}
\begin{figure}[H]
	\centering
	\captionsetup{width=0.9\textwidth, font=footnotesize, textfont=bf}	
	\includegraphics[width=0.9\linewidth]{Images/MontagemConsole/EsquematicoConversorTTL-RS485.eps}
	\caption{Esquemático do Conversor UART TTL / UART RS485}
	\vspace{-3.5mm}
	\caption*{Fonte: Autoria Própria}
	\label{fig:EsquematicoConversorTTL-RS485}
\end{figure} 
\vspace{9mm}

\vspace{9mm}
\begin{figure}[H]
	\centering
	\captionsetup{width=0.35\textwidth, font=footnotesize, textfont=bf}	
	\includegraphics[width=0.35\linewidth]{Images/MontagemConsole/EsquematicoRaspberry.eps}
	\caption{Esquemático Raspbery Pi Zero W}
	\vspace{-3.5mm}
	\caption*{Fonte: Autoria Própria}
	\label{fig:EsquematicoRaspberry}
\end{figure} 
\vspace{9mm}

Após montar montar o esquemático elétrico da placa de integração, é feito o roteamento e o \textit{layout} de montagem da placa. Os componentes utilizados nesta placa são em sua maioria SMD (\textit{Surface Mount Device}), o que reduziu o espaço de placa utilizado e possibilitou o uso de conectores de saída maiores e mais resistentes. As Figuras (\ref{fig:LayoutPCB_DP0507_0A0}) e (\ref{fig:LayoutPCB_DP0507_0A0B}) apresentam os \textit{layouts} de montagem da placa de integração, mostrando os roteamentos, a serigrafia e os componentes. 


\vspace{9mm}
\begin{figure}[H]
	\centering
	\captionsetup{width=0.7\textwidth, font=footnotesize, textfont=bf}	
	\includegraphics[width=0.7\linewidth]{Images/MontagemConsole/LayoutPCB_DP0507_0A0.eps}
	\caption{Layout de Montagem DP0507-0A0 - Superior}
	\vspace{-3.5mm}
	\caption*{Fonte: Autoria Própria}
	\label{fig:LayoutPCB_DP0507_0A0}
\end{figure} 
\vspace{9mm}

\vspace{9mm}
\begin{figure}[H]
	\centering
	\captionsetup{width=0.7\textwidth, font=footnotesize, textfont=bf}	
	\includegraphics[width=0.7\linewidth]{Images/MontagemConsole/LayoutPCB_DP0507_0A0B.eps}
	\caption{Layout de Montagem DP0507-0A0 - Inferior}
	\vspace{-3.5mm}
	\caption*{Fonte: Autoria Própria}
	\label{fig:LayoutPCB_DP0507_0A0B}
\end{figure} 
\vspace{9mm}


Para facilitar a visualização final as Figuras (\ref{fig:3D_DP0507-0A0}) e (\ref{fig:3D_DP0507-0A0B}) apresentam o modelo 3D da placa de integração.  


\vspace{9mm}
\begin{figure}[H]
	\centering
	\captionsetup{width=0.7\textwidth, font=footnotesize, textfont=bf}	
	\includegraphics[width=0.7\linewidth]{Images/MontagemConsole/3D_DP0507-0A0.JPG}
	\caption{Modelo 3D DP0507-0A0 - Inferior}
	\vspace{-3.5mm}
	\caption*{Fonte: Autoria Própria}
	\label{fig:3D_DP0507-0A0}
\end{figure} 
\vspace{9mm}

\vspace{9mm}
\begin{figure}[H]
	\centering
	\captionsetup{width=0.7\textwidth, font=footnotesize, textfont=bf}	
	\includegraphics[width=0.7\linewidth]{Images/MontagemConsole/3D_DP0507-0A0B.JPG}
	\caption{Modelo 3D DP0507-0A0 - Inferior}
	\vspace{-3.5mm}
	\caption*{Fonte: Autoria Própria}
	\label{fig:3D_DP0507-0A0B}
\end{figure} 
\vspace{9mm}

Para efeito de visualização  final do novo console, é feito  também um modelo 3D do suporte de plastico com o módulo do \textit{display} instalado. As Figuras (\ref{fig:Modelo3DConsoleSiconIIIA}) e (\ref{fig:Modelo3DConsoleSiconIIIB}) apresentam este modelo 3D. Por questões de padronização, o departamento de desenvolvimento da DMS determinou que o novo modelo de console de indicadores de destino, desenvolvido neste trabalho, será denominado SICON III. Dando assim seguimento a linha de consoles SICON II, o qual é o projeto base deste trabalho.

\vspace{9mm}
\begin{figure}[H]
	\centering
	\begin{subfigure}[t]{.5\textwidth}
		\centering
		\captionsetup{width=\textwidth, font=footnotesize, textfont=bf}	
		\includegraphics[width=0.7\linewidth]{Images/MontagemConsole/Modelo3DConsoleSiconIIIA.png}
		\caption{Vista A}
		\label{fig:Modelo3DConsoleSiconIIIA}
	\end{subfigure}%
	\begin{subfigure}[t]{.5\textwidth}
		\centering
		\captionsetup{width=\textwidth, font=footnotesize, textfont=bf}	
		\includegraphics[width=0.7\linewidth]{Images/MontagemConsole/Modelo3DConsoleSiconIIIB.png}
		\caption{Vista B}
		\label{fig:Modelo3DConsoleSiconIIIB}
	\end{subfigure}%
	\caption{Modelo 3D Console Sicon III}
	\vspace{-3.5mm}
	\caption*{Fonte: Autoria Própria}
	\label{fig:Modelo3DConsoleSiconIII}
\end{figure}
\vspace{9mm}

Ao final, após a fabricação da placa de integração, todos os componentes do novo modelo de console de indicação de destino são montados dentro da caixa suporte. E assim o primeiro protótipo é montado, se semelhando em muito com o modelo 3D apresentado anteriormente, como pode ser visto nas Figuras (\ref{fig:prototipoA}) e (\ref{fig:prototipoB}).
 
\vspace{9mm}
\begin{figure}[H]
	\centering
	\captionsetup{width=0.7\textwidth, font=footnotesize, textfont=bf}	
	\includegraphics[width=0.7\linewidth]{Images/MontagemConsole/prototipoA.jpg}
	\caption{Protótipo SICON III - Lateral Esquerda}
	\caption*{Fonte: Autoria Própria}
	\label{fig:prototipoA}
\end{figure} 
\vspace{9mm}

\vspace{9mm}
\begin{figure}[H]
	\centering
	\captionsetup{width=0.7\textwidth, font=footnotesize, textfont=bf}	
	\includegraphics[width=0.7\linewidth]{Images/MontagemConsole/prototipoB.jpg}
	\caption{Protótipo SICON III - Lateral Direita}
	\vspace{-3.5mm}
	\caption*{Fonte: Autoria Própria}
	\label{fig:prototipoB}
\end{figure} 
\vspace{9mm}

\section{Realização dos Testes}

Após a montagem do protótipo é o momento da realização dos testes de interação usuário-console e  console-painéis. Por uma questão econômica, a DMS não mantém em estoque nenhum painel eletrônico de indicadores de destino. Porém oportunamente a DMS disponibilizou por um curto período de 3 dias, um painel eletrônico que estava no departamento para manutenções. É por meio deste painel que é realizado os teste de reconhecimento de painéis, configuração no nível do brilho dos painéis e envio de mensagem para afixação de informações.

O teste de reconhecimento de painéis na rede se dá pelo envio em \textit{Broadcast} de uma mensagem \textit{MSG NETWORK CONFIG}, e a consequentemente a resposta \textit{Panel ID} sequencial dos painéis. A aplicação DMSConsole possui uma rotina de inicialização que obrigatoriamente realiza o reconhecimento dos painéis, armazenando os dados oriundos das respostas \textit{Panel ID}. Se nenhum painel é reconhecido durante a inicialização da aplicação, o DMSConsole exibe no \textit{Display} um aviso ao usuário.

O teste de brilho dos painéis é feito pelo envio de uma mensagem   \textit{MSG DEFINE BRIGHTNESS} em \textit{broadcast} aos painéis, os quais devem alterar o nível de brilho de acordo com o nível desejado. O DMSConsole realiza este tipo de configuração  mediante a requisição do usuário na Página de Configuração dos Painéis.

O teste de reconhecimento e brilho são realizados praticamente simultaneamente, já que para configurar o brilho dos painéis é necessário que o DMSConsole detecte ao menos um painel na rede, caso contrário ele exibe um sinal de erro ao usuário. A configuração do brilho dos painéis é realizado com sucesso, e o painel utilizado apresenta o nível de brilho desejado, passando assim neste teste.

Em seguida é realizado o teste envio de mensagem para afixação de informações, o qual é feito através do envio de uma mensagem \textit{MSG INFO} aos painéis da rede, os quais devem apresentar as mensagens desejadas afixadas. O DMSConsole após a seleção da fonte pelo usuário, realiza uma rotina a cada 2 minutos que envia uma mensagem \textit{MSG INFO} á todos os painéis. Assim após inserir um dispositivo de armazenamento na porta USB do protótipo, é feito através da página de Seleção de Fontes a importação do ficheiro contendo o seguinte código XML:

\vspace{3mm}
\lstset{style=mystyle}
\begin{lstlisting}
<GID version="1.1">
	<Group ID="1">
		<Line ID="1" Name="Teste">
			<Destination ID="1" Name="Teste" Return="1">
				<Panel Lines="16" Columns="112">
					<Page ID="1" SBC="0" SBNAndC="2" PT="15">
						<Number Effect="None" Align="Left" Font="16x9">
						1
						</Number>
						<Text Effect="None" Align="Left" Font="17x11">
						ROTATE
						</Text>
					</Page>
				</Panel>
			</Destination>
		</Line>
	</Group>
</GID>
\end{lstlisting}
\label{code:XML2}
\vspace{3mm}

Após a importação do arquivo Xml(\ref{code:XML2}), o painel de teste apresenta imediatamente a informação desejada, como pode ser visto na Figura (\ref{fig:PainelA}). 

\vspace{9mm}
\begin{figure}[H]
	\centering
	\captionsetup{width=0.9\textwidth, font=footnotesize, textfont=bf}	
	\includegraphics[width=0.9\linewidth]{Images/MontagemConsole/PainelA.eps}
	\caption{Painel Eletrônico da Rede de Indicadores de Destino - Sem Efeito de Rolagem}
	\caption*{Fonte: Autoria Própria}
	\label{fig:PainelA}
\end{figure} 
\vspace{9mm}

Para testar a resposta do painel a modificação na mensagem \textit{MSG INFO} enviada, um novo arquivo fonte foi criado, semelhante ao utilizado anteriormente, porém com um efeito de rolagem no campo de texto do painel. O Resultado foi a exibição de um texto que se deslocava através do painel, como pode ser visto na Figura (\ref{fig:PainelB}), o que comprova o funcionamento do console dentro dos casos de testes.

\vspace{9mm}
\begin{figure}[H]
	\centering
	\captionsetup{width=0.9\textwidth, font=footnotesize, textfont=bf}	
	\includegraphics[width=0.9\linewidth]{Images/MontagemConsole/PainelB.eps}
	\caption{Painel Eletrônico da Rede de Indicadores de Destino - Com Efeito Rolagem}
	\vspace{-3.5mm}
	\caption*{Fonte: Autoria Própria}
	\label{fig:PainelB}
\end{figure} 
\vspace{9mm}

A usabilidade da interface usuário-console foi testada com auxilio do próprio departamento de desenvolvimento da DMS, requisitando que 3 voluntários do departamento testa-sem a navegação e o uso da interface. Tendo em vista que este 3 voluntários participaram o desenvolvimento do antigo modelo SICON II, e por isso já conheciam as necessidades que uma interface de console para indicadores de destino possui.

Todos o 3 voluntários elogiaram a disposição dos botões de interação e a legibilidade das informações exibidas na tela do \textit{display}. Também ouve uma boa avaliação em relação a facilidade e fluidez que a interface do console ofereceu. O único problema apresentado é o \text{delay} e o \textit{debounce} dos botões \textit{touch} apresentaram. Principalmente durante o uso do teclado virtual, o que dificulta o uso do editor de fontes do DMConsole. 

Os problemas de \text{delay} e o \textit{debounce} foram analisados, e avaliados como oriundos do próprio \text{display Touchscreen}. Já que mesmo adequadamente configurado, segundo o próprio manual do fabricante, quando há uma interação de toque do usuário, o módulo aleatoriamente apresenta um retardo na notificação ao dispositivo mestre, via UART-RS232, sobre o evento. Ou muitas vezes nem mesmo o faz. 
