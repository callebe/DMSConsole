
Nesta etapa do trabalho é desenvolvido o \textit{software} implementado no Raspberry Pi Zero W, para o novo modelo de console de indicadores de destino da DMS.  Este \textit{software} será aqui denominado DMSConsole versão 1.0, e será basicamente desenvolvido na linguagem de programação C++, utilizando algumas bibliotecas nativas de sistemas operacionais que utilizam o Kernel Linux e outras que são especificas para \textit{hardware} Raspberry Pi. Portanto o \textit{software} desenvolvido aqui pode ser compilado em diferentes modelos de \textit{hardware} Raspberry Pi, apenas necessitando de pequenos ajustes nas portas utilizadas. 

O desempenho do DMSConsole é um elemento crucial nesta aplicação, pois o tempo de execução de tarefas do \textit{software} pode interferir na execução das rotinas de comunicação dos painéis, comprometendo o correto funcionamento dos mesmo. O tempo de resposta á requisições feitas pelo usuário através do \textit{Display Touchscreen} e o tempo de inicialização do console são parâmetros que podem comprometer a experiência do usuário, e de mesmo modo dependem do desempenho da aplicação nas diferentes tarefas executadas. Assim utilizando os recursos que a linguagem C++ oferece, o desenvolvimento de cada função da aplicação DMSConsole é feita visando a otimização de recursos computacionais.

   

\section{Gerenciador XML}

Como foi visto na Seção (\ref{sec:GestorDeIndicacaoDeDestinos}) a aplicação GID a partir das informações inseridas pelo usuário, gera um conjunto de arquivos binários com as informações a serem inseridas no console, e consequentemente enviadas aos painéis eletrônicos. Este conjunto de dados gerados possui uma sintaxe própria, que somente a aplicação GID gera e somente o console do Indicador de Destino da DMS consegue ler e identificar a estrutura dos dados. Com a intenção de tornar o arquivo fonte de dados para Indicadores de Destino mais padronizado e portável para diferentes versões de console, será utilizado o XML como padrão de descrição de dados. Assim será possível gerar fonte de dados, para os Indicadores de Destino, através de qualquer aplicação de criação de arquivos XML, utilizando apenas a estrutura de dados apresentada na Figura (\ref{fig:EstruturaDeDados}).  

O XML, ou Linguagem de Marcação Extensível (\textit{Extensible Markup Language}), é um formato para criação de dados organizados de forma hierárquica, recomendado pelo W3C (\textit{World Wide Web Consortium}). O XML é uma combinação entre o flexibilidade que SGML, ou \textit{Standard Generalized Markup Language} e a simplicidade visual que o HTML, ou \textit{HyperText Markup Language} oferecem. Assim o XML oferece:  simplicidade e legibilidade dos dados, tanto para usuários quanto para \textit{softwares}; Flexibilidade, possibilitando a criação de \textit{tags} ilimitadas; interligação facilitada entre banco de dados e uma boa estruturação \cite{Bray}.

A estrutura de dados do GID, apresentada na Figura (\ref{fig:EstruturaDeDados}), é constituída por $n$ elementos 'Linha', que serão designados no padrão XML como 'Line', que estão contidos dentro de um conjunto de dados fontes para os indicadores de destino. Como padrão da DMS, todos conjuntos de dados de uma 'Linha' deve estar associada a um conjunto de painéis, e este conjunto associado ao elemento raiz GID. Assim é criado um elemento 'GID' (Gestor de Indicadores de Destino), o qual pode possuir $n$ elementos 'Group', os quais representam grupos de painéis eletrônicos que estão a ser geridos. Estes grupos são elementos que contem os elementos 'Line', com seus atributos e seus elementos relacionados. Logo como exemplo, considerando um arquivo XML que contém informação a cerca de uma linha de autocarros denominada 'Aliados-Viso' de número 201, o qual possuí como destinos possíveis o 'Planetário' ou a rua 'PR. D. JOÃO I'. E que exista apenas um painel de dimensões 16x112 pixeis, onde as informações devam ser mostradas em uma página de configuração número da linha + nome do destino, com espaço de 2 pixeis entre o número e nome, e com 1 pixel entre caracteres do nome. O arquivo XML para este GID especifico é dado da seguinte forma: 

\vspace{3mm}
\lstset{style=mystyle}
\begin{lstlisting}
<GID version="1.1">
  <Group ID="1">
    <Line ID="201" Name="ALIADOS-VISO">
      <Destination ID="1" Name="PLANETÁRIO" Return="1">
        <Panel Lines="16" Columns="112">
          <Page ID="1" SBC="1" SBNAndC="2" PT="15">
            <Number Effect="None" Align="Left" Font="16x9">
              201
            </Number>
            <Text Effect="None" Align="Left" Font="5x5">
              PLANETÁRIO
            </Text>
          </Page>
        </Panel>
      </Destination>
      <Destination ID="2" Name="PR. D. JOÃO I" Return="2">
        <Panel Lines="16" Columns="112">
          <Page ID="6" SBC="1" SBNAndC="2" PT="15">
            <Number Effect="None" Align="Left" Font="12x7">
              201
            </Number>
            <Text Effect="None" Align="Left" Font="5x5">
              PR. D. JOÃO I
            </Text>
          </Page>
        </Panel>
      </Destination>
    </Line>
  </Group>
</GID>
\end{lstlisting}
\label{code:XML}
\vspace{3mm}

O \textit{software} DMSConsole deve ser capaz de ler um arquivo XML com as informações da estrutura de dado GID, como apresentado em (\ref{code:XML}), e ainda quando necessário criar um arquivo XML semelhante. O DMSConsole deve possibilitar ao usuário criar, através da interface de usuário, um arquivo XML com a estrutura de dados GID, para servir de fonte para os dados apresentados nos painéis. Existem varias bibliotecas prontas, em C++, para leitura e criação de arquivos XML, porém para tornam as funções de leitura e criação mais eficientes, e reduzir a complexabilidade do código, fora desenvolvido uma biblioteca própria nomeada GIDxml.

As funções de leitura e criação da biblioteca GIDxml utilizam uma estrutura de dados semelhante a GID, porém com um sistema de alocação dinâmica de memória. A alocação dinâmica permite uma melhor gestão e maior capacidade de uso da memória da aplicação, tornando possível a aplicação ler arquivos XML de maior volume.  
\section{Gerenciador Painéis}

Para que a aplicação DMSConsole seja capaz te gerenciar a rede de painéis eletrônicos conectada ao console e atender as requisições feitas através da interface de usuário, é desenvolvida a biblioteca DMSDisplay.  Esta biblioteca contem as funções capazes de efetuar o reconhecimento e configurações dos dispositivos da rede de indicadores de destino, para tal é esta biblioteca se utiliza de uma interface de comunicação serial emulada, e dois \textit{timers} do sistema Linux. Estes \textit{timers}  são uteis para realizar algumas rotinas de configurações e manter o procedimento cíclico de atualização dos painéis. 

\subsection{Bit Bang para UART - RS485}
O protocolo LDESIGN é estabelecido em uma interface UART-RS485 com um \textit{Baud Rate} de 9600bps, com 8 bits de dados e 1 \textit{Stop Bit}. Como apresentado anteriormente no Capítulo \ref{cap:Raspberry}, o \textit{Raspberry Pi Zero W} possui apenas uma interface de comunicação UART, o qual já é utilizada neste projeto, para a comunicação em UART-RS232 com o \textit{display touchscreen}. Para solucionar este problema é utilizado um recurso de emulação de interface de comunicação por \textit{software} chamado \textit{Bit Bang}.

Utilizando os recursos de leitura e escrita de dados nas portas digitais disponíveis da GPIO  e obedecendo a estrutura do protocolo de comunicação é possível emular, via \textit{software}, o comportamento de uma interface UART, adicionando mais um recurso de comunicação ao \textit{Raspberry Pi Zero W}. Porém um dos obstáculos a ser enfrentado nesta tarefa é a velocidade leitura e processamento dos dados recebidos e transmitidos por essa interface emulada, já que o menor atraso acarreta facilmente erros na transmissão e/ou recepção. Em um sistema que possui um \textit{Hardware} exclusivo para comunicação, como um modem UART, a amostragem dos sinais de entrada, a modulação dos sinais de saída, os níveis de tensão deste sinais, a sincronização e o armazenamento temporário são controladas independentemente da execução do \textit{software} pelo processador.  Já no \textit{Bit Bang} todos estes parâmetros devem ser controlados pelo \textit{software}.  

Já exitem bibliotecas em C++ que implementam o \textit{Bit Bang} com um custo computacional bastante reduzido, mesmo assim o limite da velocidade de comunicação, \textit{Baud Rate}, ainda é limitado e depende da velocidade de processamento do dispositivo embarcado. O \textit{Raspberry Pi Zero W} possui um processador de 1GHz \textit{single core} que prove uma boa velocidade de processamento, e consequentemente torna possível emular interfaces de comunicação com um \textit{baud rate} considerável. Nesta aplicação é utilizado a biblioteca \textit{PiGPIO}, disponível em \citeonline{abyz}, o qual oferece uma variedade de funções em C para comunicação serial via \textit{bit bang}.

Os pinos da GPIO do \textit{Raspberry Pi Zero W} possuem um nível de tensão de 0V á 3,3V, e consequentemente qualquer interface de comunicação estabelecido estará neste limite de tensão. Já que o UART-485 opera como tensões diferenciais em uma faixa além da oferecida pelo \textit{Raspberry}, se faz necessário utilizar um conversor UART TLL / UART-485. Neste projeto o conversor utilizado é o CI SP3481 - Sipex, o qual apresenta no lado TLL 4 pinos, sendo eles; porta de envio, recepção, habilitação de envio e aterramento, no lado 485 há apenas duas portas diferencias A B. A Figura \ref{fig:ConversorUARTTTL485} apresenta o esquemático da conexão entre este conversor e o \textit{Raspberry}.

\vspace{9mm}
\begin{figure}[H]
	\centering
	\captionsetup{width=0.9\textwidth, font=footnotesize, textfont=bf}	
	\includegraphics[width=0.9\linewidth]{Images/SoftwareDMSConsole/ConversorUARTTTL485.eps}
	\caption{Conversor UART TTL - UART 485}
	\vspace{-3.5mm}
	\caption*{Fonte: \citeonline{DMSManual}}
	\label{fig:ConversorUARTTTL485}
\end{figure} 
\vspace{9mm}

Assim através da interface de comunicação emulada via \textit{bit bang}, utilizando a porta 20 da GPIO para a habilitação de envio, a porta 23 para envio da mensagem e 24 para a recepção,  a comunicação entre console e painéis é feita no padrão LDESIGN.

\subsection{Protocolo LDESIGN}

Os painéis eletrônicos utilizados nos indicadores de destino da DMS possuem um protocolo de comunicação próprio desenvolvido pela DMS, o qual é chamado de protocolo LDESIGN. Este protocolo possibilita que sejam enviados informação de controle e notificação para qualquer dispositivo que integra a rede de comunicação dos indicadores. A rede de comunicação dos indicadores de destino é normalmente composta por um console, que funciona no modo \textit{Master}, e até 16 painéis funcionando do modo \textit{Slave}. No protocolo de comunicação LDESIGN qualquer mensagem enviada ou recebida por um dispositivo da rede segue o seguinte formato:

\vspace{5mm}
\begin{table}[H]
	\centering
	\captionsetup{width=0.8\linewidth}
	\begin{tabular}{|c|c|l|c|}
		\hline
		\cellcolor[HTML]{000000}{\color[HTML]{FFFFFF}Ordem} & \cellcolor[HTML]{000000}{\color[HTML]{FFFFFF}Comando} & \cellcolor[HTML]{000000}{\color[HTML]{FFFFFF}Descrição} & \cellcolor[HTML]{000000}{\color[HTML]{FFFFFF}Nº bits} \\
		\hline
		1º     & \textless{}SOH\textgreater{}  & \textit{Start of heading} - 81h      & 8           \\
		\hline
		2º     & Destino                       & ID do dispositivo destino            & 8           \\
		\hline
		3º     & Origem                        & ID do dispositivo origem             & 8           \\
		\hline
		4º     & \textless{}STX\textgreater{}  & \textit{Start of text}    - 82h      & 16          \\
		\hline
		5º     & N                             & Tamanho em Bytes dos Dados + 1       & 8           \\
		\hline
		6º     & Tipo                          & Tipo de dado enviado                 & 8           \\
		\hline
		7º     & Dados                         & Dados a serem enviados               & N           \\
		\hline
		8º     & \textless{}ETX\textgreater{}  & \textit{End of Text}      - 83h      & 8           \\
		\hline
		9º     & \textless{}CHKS\textgreater{} & \textit{checksum}-soma de todos os Bytes   & 8           \\
		&                               & da mensagem, SOH até ETX       &             \\
		\hline
	\end{tabular}
	\caption{Formato Geral - Protocolo Geral de Comunicação LDESIGN}
	\caption*{Fonte: \citeonline{DMSManual}}
	\label{tab:ProtocoloComunicacaoMain}
\end{table}
\vspace{5mm}

O ID (\textit{Identificador}) de destino e de origem são dados específicos de cada dispositivo, por exemplo, normalmente o dispositivo console tem por padrão o ID 0x00 e o painel com as maiores dimensões da rede tem o ID 0x01. Os comandos 'Tipo' e 'Dados' são de acordo com o tipo de mensagem a ser enviada pelo protocolo, na seção \ref{subsection:MensageConsolePanel} especifica os valores para tais comandos.

Quando o console faz uma requisição a um painel especifico, por exemplo ao painel ID 0x05, o comando de Destino e Origem são respectivamente 0x05 e 0x00, e o painel responde com uma mensagem com ID de Destino 0x00 e Origem 0x05. Porém quando o console deseja realizar uma requisição tipo \textit{Broadcast}, ou seja à todos os painéis da rede ao mesmo tempo, o ID de Destino deve ser 0xFF e a Origem 0x00. Cada painel irá responder a requisição do console de forma sequência, cronometrada de acordo com seu valor de ID multiplicada por 100 ms. Por exemplo, em uma rede com dois painéis de ID 0x01 e 0x03, o painel de ID 0x01 responde 100 ms depois do fim da transmissão \textit{Broadcast} do console. Já o painel de ID 0x01 responde 300 ms depois do fim da da transmissão \textit{Broadcast} do console, garantindo assim a não sobreposição de respostas dos painéis.    

Dentro do protocolo de comunicação LDESIGN há um conjunto de tipos de mensagem os quais possuem um alvo especifico dentro da rede de comunicação. O console dentro dessa rede é um dispositivo \textit{master} que realiza as requisições aos painéis, com mensagens console-painéis, e os painéis respondem com mensagens painel-console. Há no total 9 tipos de mensagens console-painéis, e 4 do tipos de mensagens  painéis-console, o DMSConsole deve ser capaz de enviar e receber tais mensagens, mediante a requisição do usuário. Para cada mensagem é desenvolvido uma função em C++ para executar a transmissão ou recepção dos dados como requerido pelo protocolo. No protocolo LDESIGN o comando 'Dados' é o conjunto de Bytes da mensagem a ser enviada para o destinatário, as subseções a seguir apresentam os tipos de mensagem a serem enviados e qual valor que o comando 'Tipo' deve tomar para cada mensagem. 

\subsubsection{MSG Network Config}
\label{subsection:MensageConsolePanel}
Esta mensagem realiza o reconhecimento dos dispositivos conectados a rede de painéis eletrônicos. Esta mensagem é transmitida pelo console em \textit{broadcast} usando o endereço 0xFF á todos os painéis, os quais respondem a requisição com uma mensagem 'Painel ID'\ref{sec:PainelID}, em sequência de acordo com o seu ID. O byte 'Tipo' desta mensagem é definido como 0x22, 'N' é igual a 2, e não existem bytes a serem enviados no comando 'Dados'. Ao final de cada Painel ID ainda é enviado um byte 'ACK' ou 'NACK' de reconhecimento.

\subsubsection{MSG Define Brightness}
Através desta mensagem é possível configurar o nível de brilho de cada painel. Esta mensagem é enviada pelo console e pode ser endereçada para um painel especifico, ou enviada por \textit{broadcast} via endereço 0xFF. O byte 'Tipo' desta mensagem é 0x26, e 'N' é igual 2. O comando 'Dados' é definido como 1 byte em ASCII que representam a intensidade do brilho a ser utilizado no painel, sendo definido:

\begin{itemize}
	\item '1' Nível 1 de Brilho
	\item '2' Nível 2 de Brilho
	\item '3' Nível 3 de Brilho
	\item '4' Nível 4 de Brilho
	\item '5' Nível 5 de Brilho
	\item '6' Nível 5 de Brilho
	\item 'A' Nível Automático 
\end{itemize}

Em resposta a esta mensagem o painel deve enviar uma mensagem 'ACK' em caso reconhecer e validar a mensagem, ou caso contrário deve ser enviado  uma mensagem 'NACK'.
	
\subsubsection{MSG Reset}
Esta mensagem destina-se a realização de limpeza na memória dos painéis eletrônicos, colocando estes no estado de arranque. O byte tipo desta mensagem é definido como 0x1A, o byte 'N' é 1, não existe bytes a serem enviados no comando 'Dados'. Esta mensagem é enviada pelo console e pode ser destinada a um  painel, ou transmitida a todos pelo endereço 0xFF. Após o envio desta mensagem o painel deve responder com um comando 'ACK' se este reconhecer a mensagem, caso contrário ele deve mandar uma comando 'NACK'.
	
\subsubsection{MSG INFO}
Esta mensagem é enviada pelo console e contém dados que descrevem as informações a serem afixadas em um painel especifico. Esta mensagem é enviada individualmente para cada painel, o byte 'Tipo' desta mensagem é definido como 0x21, e o Byte 'N' é variável de acordo com a mensagem o número total de Bytes presentes nessa mensagem. O comando 'Dados' segue uma estrutura geral descrita abaixo:

\vspace{5mm}
\begin{table}[H]
	\centering
	\captionsetup{width=0.8\linewidth}
	\begin{tabular}{|c|c|l|c|}
		\hline
		\cellcolor[HTML]{000000}{\color[HTML]{FFFFFF}Ordem} & \cellcolor[HTML]{000000}{\color[HTML]{FFFFFF}Comando} & \cellcolor[HTML]{000000}{\color[HTML]{FFFFFF}Descrição} & \cellcolor[HTML]{000000}{\color[HTML]{FFFFFF}Nº Bytes} \\
		\hline
		1º     & Index              & Contador de Referência   & 1      \\
		\hline
		2º     & Page General Info  & Informações gerais sobre as   & 3      \\
		&                    & páginas a seguir              &        \\
		\hline
		3º     & Stream ID          & Define se a mensagem é BITMAP & 1      \\
		&                    & ou ASCII                      & 1      \\
		\hline
		4º     & Page Info 1        & Descrição da Pagina 1  & N   \\
		\hline
		5º     & Page Info 2        & Descrição da Pagina 2 (Opcional) & N   \\
		\hline
		6º     & Page Info 3        & Descrição da Pagina 3 (Opcional) &     \\
		\hline
		7º     & \textless{}END\textgreater{} & \textit{End of Message} - 23h    & 1    \\
		\hline
	\end{tabular}
	\caption{Formato Geral - MSG Info}
	\vspace{-3.5mm}
	\caption*{Fonte: \citeonline{DMSManual}}
	\label{tab:GeralMSG_INFO}
\end{table}
\vspace{5mm}

Cada painel possui um contador \textit{TimeOut} que cronometra o tempo decorrido desde a ultima mensagem tipo MSG INFO enviada. Quando este contador atingi o valor de 2 minutos o painel apaga as informações fixadas. Assim, no DMSConsole deve haver uma rotina que, no máximo a cada 2 minutos, reenvia automaticamente mensagens do tipo MSG INFO a todos os painéis da rede, mesmo que estas mensagens sejam iguais as ultimas mensagens enviadas. Para que o \textit{firmware} dos painéis não precise apagar e reescrever os dados fixados toda a vez em que mensagens tipo MSG INFO exatamente iguais são enviadas com o intuito de evitar que o contator \textit{TimeOut} estoure, o primeiro Byte da mensagem, o 'Index', somente é incrementado quando a mensagem a ser enviada é diferente da anterior.

O comando 'Page Geral Info' é o conjunto de 3 Bytes que descrevem as informações a cerca das páginas a serem fixadas no painel de destino, a Figura (\ref{fig:PageGeneralInfoMSG_INFO}) apresenta a descrição deste Bytes na ordem MSB  (\textit{Most Significant Bit}).

\vspace{9mm}
\begin{figure}[H]
	\centering
	\captionsetup{width=\textwidth, font=footnotesize, textfont=bf}	
	\includegraphics[width=\linewidth]{Images/PageGeneralInfoMSG_INFO.eps}
	\caption{MSG Info - Page General Info}
	\vspace{-3.5mm}
	\caption*{Fonte: \citeonline{DMSManual}}
	\label{fig:PageGeneralInfoMSG_INFO}
\end{figure} 
\vspace{9mm}

O comando 'STREAM ID' tem dois formato diferentes, quando a mensagem é no sentido painel-console 'STREAM ID' é composto com 1 byte ASCII com o caractere 'A' quando a informação é no formato ASCII, ou 'B' quando é no formato BITMAP. Já se a mensagem é no sentido console-painel o comando 'STREAM ID' é composto por 5 bytes, se estes bytes forem preenchidos corretamente com a sequência de caracteres 'ASCII' a mensagem é classificada como  ASCII, ou caso contrário ela é classificada como BITMAP.

O comando 'Page Info' descreve as informações a serem visualizadas nos painéis, sendo estas informações dividias por páginas, as quais podem possuir o número da linha e até 3 campos de texto. E um painel é permitido de 1 á 3 paginas, sendo obrigatório haver ao menos uma página. A estrutura do comando 'Page Info' é descrita na Tabela \ref{tab:PageInfoMSG_INFO}.

\vspace{5mm}
\begin{table}[H]
	\centering
	\captionsetup{width=0.8\linewidth}
	\begin{tabular}{|c|c|l|c|}
		\hline
		\cellcolor[HTML]{000000}{\color[HTML]{FFFFFF}Ordem} & \cellcolor[HTML]{000000}{\color[HTML]{FFFFFF}Comando} & \cellcolor[HTML]{000000}{\color[HTML]{FFFFFF}Descrição} & \cellcolor[HTML]{000000}{\color[HTML]{FFFFFF}Nº Bytes} \\
		\hline
		1º     & Page Header   & Cabeçalho de definição das informações sobre a & 3   \\
		&               & página                                         &     \\
		\hline
		2º     & Bus Line      & Conjunto de Bytes em ASCII que representam o   & N   \\
		&               & número da Linha                                &     \\
		\hline
		3º     & Info Line 1   & Conjunto de Bytes em ASCII que representam o   & N   \\
		&               & texto 1 a ser afixado  (Opcional)              &     \\
		\hline
		4º     & \textless CR \textgreater \textless LF\textgreater  & Separadores de blocos Page Info - 0x0D 0x0A    & 2   \\
		&               & (Opicional)                                    &     \\
		\hline
		5º     & Info Line 2   & Conjunto de Bytes em ASCII que representam o   & N   \\
		&               & texto 2 a ser afixado  (Opcional)              &     \\
		\hline
		6º     & \textless CR \textgreater \textless LF\textgreater  & Separadores de blocos Page Info - 0x0D 0x0A    & 2   \\
		&               & (Opicional)                                    &     \\
		\hline
		7º     & Info Line 3   & Conjunto de Bytes em ASCII que representam o   & N   \\
		&               & texto 3 a ser afixado  (Opcional)              &     \\
		\hline
	\end{tabular}
	\caption{Formato Page Info - MSG Info}
	\vspace{-3.5mm}
	\caption*{Fonte: \citeonline{DMSManual}}
	\label{tab:PageInfoMSG_INFO}
\end{table}
\vspace{5mm}

O 'Page Header' é o cabeçalho que descreve cada página a ser transmitida, sendo que este comando possui apenas 3 Bytes, a serem preenchidos na seguinte forma:

\vspace{9mm}
\begin{figure}[H]
	\centering
	\captionsetup{width=\textwidth, font=footnotesize, textfont=bf}	
	\includegraphics[width=\linewidth]{Images/PageInfo_Header.eps}
	\caption{MSG Info - Page Info Header}
	\vspace{-3.5mm}
	\caption*{Fonte: \citeonline{DMSManual}}
	\label{fig:PageInfo_Header}
\end{figure} 
\vspace{9mm}

Onde:

\begin{itemize}
	\item \textbf{Nº Linhas :} Número de campos de texto na página, de 0 a 3 páginas.
	\item \textbf{Info Visual :} Formato das informações a serem exibidas, sendo as opções:
	\subitem 00 - Apenas o número da linha
	\subitem 00 - Apenas o número da linha
	\subitem 10 - O número da linha e os campos de texto
	\subitem 11 - Nenhuma informação
	\item \textbf{Alinha. Número \ Alinha. Texto 1,2 e 3 :} Alinhamento do número da linha e dos campos de texto, sendo as opções para cada elemento:
	\subitem 00 - Esquerda
	\subitem 01 - Centro
	\subitem 10 - Direita
	\subitem 11 - Não identificado
	\item \textbf{Efeito Número \ Efeito Texto 1,2 e 3 :} Efeito a ser aplicado no número da linha e nos campos de texto, sendo as opções para cada elemento:
	\subitem 000 - Sem efeito
	\subitem 001 - Piscar
	\subitem 010 - Rodar
	\subitem 011 - Não definido
	\item \textbf{ID Fonte Número \ ID Fonte Texto 1, 2 e 3 :} Tamanho da fonte a ser aplicada no número da linha e nos campos de texto. Estas fontes são carregadas no Firmware dos painéis e podem mudar de acordo com a versão do painel. Na maioria dos modelos de painéis eletrônicos da DMS as opções de fonte são:
	\subitem 0x00 - 5x5
	\subitem 0x01 - 7x5
	\subitem 0x02 - 8x6
	\subitem 0x03 - 11x7
	\subitem 0x04 - 12x7
	\subitem 0x05 - 13x9
	\subitem 0x06 - 14x9
	\subitem 0x07 - 15x9
	\subitem 0x08 - 16x9
	\subitem 0x09 - 17x11
	\subitem 0x10 - 19x11
	
\end{itemize}

O comando 'Page Info' deve ser seguido comando 'Bus Line', o qual nada mais é do que o conjunto de caracteres ASCII que representam o número da linha. Deve ser observar que o número de bytes 'Bus Line' deve ser o mesmo já definido em  'Page Header'. Após o comando 'Bus Line' se existir o campos de texto 1 é necessário enviar o conjunto de caracteres ASCII que representam a mensagem do texto 1, observando que o limite de 29 caracteres. Se existir um texto 2 é necessário enviar o comando \textless CR \textgreater \textless LF\textgreater para separar os blocos, o mesmo deve ocorrer com o texto 3. Após o envio do MSG Info o painel alvo da mensagem deve enviar um comando 'ACK', se este reconhecer a mensagem e a validar, se não ele envia um comando 'NACK'.

\subsubsection{MSG Panel Test}
Esta mensagem destina-se a realização de testes básicos nos painéis. Esta mensagem pode ser endereçada a um painel ou enviada em \textit{broadcast} via endereço 0xFF a todos os painéis da rede. O comando 'Tipo' desta mensagem é definido como 0x40, e 'N' é igual a 2. O comando 'Dados' desta mensagem define qual tipo de teste será realizado, sendo sa seguinte forma:

\begin{itemize}
	\item 0x01 - Teste de RAM e FLASH
	\item 0x02 - Teste de varrimento vertical de LEDs
	\item 0x03 - Teste de varrimento horizontal de LEDS
\end{itemize}

\subsubsection{ACK e NACK}

Esta mensagem é enviada por um painel em resposta a requisição realizada pelo console. A mensagem ACK ou \textit{acknowledge} informa ao console que a mensagem recebida foi reconhecida e validada. Já a mensagem NACK ou  \textit{not acknowledge} informa ao console que a mensagem recebida não foi reconhecida. A mensagem 'ACK' tem como byte 'Tipo' o valor 0x86 e N = 2, já a mensagem 'NACK' tem 'Tipo' igual a 0x95 e também 'N' igual a 2. Ambos as mensagens não possuem informação 'Dados'.     

\subsubsection{Panel ID}
\label{sec:PainelID}
Esta mensagem é enviada por uma painel em resposta a uma mensagem MSG Network Config \ref{subsection:MensageConsolePanel}. Através desta mensagem o console indentificar as configurações fisicas dos paineis conectados a rede. O comando 'Tipo' desta mensagem é definido como 0x61 e 'N' é igual a 5. O comando 'Dados' desta mensagem é constituída da seguinte forma:
 
\vspace{5mm}
\begin{table}[H]
	\centering
	\captionsetup{width=\linewidth}
	\begin{tabular}{|c|c|l|c|}
		\hline
		\cellcolor[HTML]{000000}{\color[HTML]{FFFFFF}Ordem} & \cellcolor[HTML]{000000}{\color[HTML]{FFFFFF}Comando} & \cellcolor[HTML]{000000}{\color[HTML]{FFFFFF}Descrição} & \cellcolor[HTML]{000000}{\color[HTML]{FFFFFF}Nº bits} \\
		\hline
		1º     & Endereço  & Endereço do painel na rede                   & 1  \\
		\hline
		2º     & Linhas    & Número de linhas físicas de LED  do painel   & 1  \\
		\hline
		3º     & Colunas   & Número de colunas físicas de LED  do painel  & 1 \\
		\hline
		4º     & Aux       & Define se o painel suporta destinos alternativos  & 1 \\
		\hline
	\end{tabular}
	\caption{Formato Panel ID}
	\caption*{Fonte: \citeonline{DMSManual}}
	\label{tab:PanelID}
\end{table}
\vspace{5mm}

\section{Gerenciador Interface}

A interface do usuário é um dos elementos principais deste trabalho. Diferente do modelo SICON II, usado como base, o novo modelo de console desenvolvido possui um recurso de interface mais versátil; o \textit{display touchscreen}. Utilizando o \textit{display touchscreen} é possível criar um ambiente gráfico mais amigável e simples, que explore as funcionalidades do novo console. 

O console de indicadores de destino deve possuir uma interface que facilite ao motorista configurar os painéis e manipular as informações a serem exibidas de forma mais prática o possível. Deve se ter em mente que a usabilidade do console esta intimamente ligada ao tipo de rotina que o autocarro possui. Se o autocarro realiza sempre o mesmo trajeto, em um ambiente urbano pro exemplo, provavelmente as configurações e personalizações das informações  fixadas nos painéis raramente mudem. Sendo assim é mais prático utilizar a aplicação GID em um computador, e apenas exportar o arquivo fonte para um dispositivo USB e carrega-lo no console. Porém quando o trajeto do autocarro varia frequentemente, ou ainda há uma necessidade periódica de alterar informações dos painéis, se torna mais interessante existir uma ferramenta no próprio console que possibilite criar um arquivo fonte.

No antigo modelo de console SICON II não há Fontes editor de fontes no console, e consequentemente a interface do usuário era mais simples. Já que os dados fonte eram passados via conexão USB, em formato hexadecimal, para dentro do console, bastando apenas o utilizador selecionar a fonte. No novo modelo de console haverá 3 opções de origem das fontes de dados; transferência via USB, transferência via SSH e a criação da fonte direto no console todos em formato XML(Figura \ref{fig:InputNovoConsole}). Assim a interface do novo console deve agregar novas funcionalidade, porém sem se tornar demasiadamente complexa.

\vspace{3mm}
\begin{figure}[H]
	\centering
	\captionsetup{width=0.9\textwidth, font=footnotesize, textfont=bf}	
	\includegraphics[width=0.9\linewidth]{Images/SoftwareDMSConsole/InputOldConsole.eps}
	\caption{Fonte de Dados - SICON II}
	\vspace{-3.5mm}
	\caption*{Fonte: Autoria Própria}
	\label{fig:InputSICONII}
\end{figure} 
\vspace{3mm}

\vspace{3mm}
\begin{figure}[H]
	\centering
	\captionsetup{width=0.9\textwidth, font=footnotesize, textfont=bf}	
	\includegraphics[width=0.9\linewidth]{Images/SoftwareDMSConsole/InputNewConsole.eps}
	\caption{Fonte de Dados - Novo Console}
	\vspace{-3.5mm}
	\caption*{Fonte: Autoria Própria}
	\label{fig:InputNovoConsole}
\end{figure} 
\vspace{3mm}

A primeira pagina da interface a ser construída é a página de Seleção de Destinos, Figura \ref{fig:FrameworkMain}. Nesta página,  dado um aquivo de fonte previamente carregado e uma linha selecionada, o motorista pode selecionar qual é o destino final desta linha. Assim que o motorista seleciona o destino final, o console busca dentro da estrutura de dados do destino o conjunto de painéis que possuem as dimensões compatíveis com os painéis disponíveis da rede no momento, e envia os dados para os painéis compatíveis.   

\vspace{3mm}
\begin{figure}[H]
	\centering
	\captionsetup{width=0.9\textwidth, font=footnotesize, textfont=bf}	
	\includegraphics[width=0.9\linewidth]{Images/SoftwareDMSConsole/FrameworkMain.eps}
	\caption{Página de Seleção de Destinos - DMSConsole}
	\vspace{-3.5mm}
	\caption*{Fonte: Autoria Própria}
	\label{fig:FrameworkMain}
\end{figure} 
\vspace{3mm}

Através do botão de mudança de linha (botão vermelho a direita da tela), presente na página Seleção de Destinos, o motorista tem acesso a página de Seleção de Linha, Figura (\ref{fig:FrameworkMainSelectDestinationsB}). Nesta página o motorista pode selecionar uma linha para o autocarro dentre as linha presentes no arquivo fonte previamente carregado. O motorista pode utilizar o teclado virtual desta página para buscar a linha de interesse pelo seu número.

\vspace{3mm}
\begin{figure}[H]
	\centering
	\captionsetup{width=0.9\textwidth, font=footnotesize, textfont=bf}	
	\includegraphics[width=0.9\linewidth]{Images/SoftwareDMSConsole/FrameworkMainSelectDestinationsB.eps}
	\caption{Página de Seleção de Linha - DMSConsole}
	\vspace{-3.5mm}
	\caption*{Fonte: Autoria Própria}
	\label{fig:FrameworkMainSelectDestinationsB}
\end{figure} 
\vspace{3mm}

Para acessar as configurações do DMSConsole, o usuário através do botão 'Settings', no topo de qualquer página da interface, pode acessar o Menu de Configurações, Figura \ref{fig:SettingsDMSConsole}. Nesta página o usuário tem acesso a página de seleção de Fonte e as páginas de configuração do RTC (\textit{Real Clock Time}), \textit{display touchscreen} e do painéis eletrônicos da rede.

\vspace{3mm}
\begin{figure}[H]
	\centering
	\captionsetup{width=0.9\textwidth, font=footnotesize, textfont=bf}	
	\includegraphics[width=0.9\linewidth]{Images/SoftwareDMSConsole/FrameworkSettingsMain.eps}
	\caption{Página do Menu de Configurações - DMSConsole}
	\vspace{-3.5mm}
	\caption*{Fonte: Autoria Própria}
	\label{fig:SettingsDMSConsole}
\end{figure} 
\vspace{3mm}

Na página de Seleção de Fonte o usuário tem acesso a uma lista de arquivos fonte em formato Xml que já foram previamente carregados no diretório padrão e que podem ser escolhidos como nova fonte de dados, Figura \ref{fig:SourceDMSConsole}. Para carregar um novo arquivo fonte para este diretório o usuário pode escolher se conectar ao Raspberry Pi via SSH e copiar o arquivo fonte para dentro do diretório 'Data' no diretório de instalação do DMSConsole. Também há a opção de importar diretamente de um dispositivo de armazenamento USB uma nova fonte, porém ao realizar selecionar um arquivo o DMSConsole verifica a estrutura Xml do arquivo antes de importa-lo. Ainda há a terceira opção, a de criar um arquivo fonte Xml.

\begin{figure}[H]
	\centering
	\captionsetup{width=0.9\textwidth, font=footnotesize, textfont=bf}	
	\includegraphics[width=0.9\linewidth]{Images/SoftwareDMSConsole/FrameworkSource.eps}
	\caption{Página de Seleção de Fonte - DMSConsole}
	\vspace{-3.5mm}
	\caption*{Fonte: Autoria Própria}
	\label{fig:SourceDMSConsole}
\end{figure} 
\vspace{3mm}

Ao escolher a opção 'Criar Fonte' o usuário é direcionado para editor de fontes do DMSConsole, onde ele define os parâmetro da Linha e do Destino do autocarro, os parâmetros de dimensões dos painéis, o layout das páginas e o alinhamento  das informações visuais nos painéis. E então o DMSConsole gera um arquivo Xml baseados nestas informações, para ser utilizado como fonte. Para facilitar a entrada de dados pelo usuário as páginas do editor de fontes possui um teclado virtual adaptado do padrão \textit{QWERTY}. 

Após inserir o nome do arquivo, o nome e numero da linha e o nome do destino, o DMSConsole detecta as configurações dos painéis da rede, e oferece ao usuário a criação 'Paginas' de acordo com a dimensão de cada painel. Porém se não for detectado nenhum painel da rede, o usuário pode inserir manualmente as dimensões dos painéis. No processo de criação da página o usuário tem a opção de escolher quais informações serão exibidas nos painéis; texto, apenas o número da linha, o texto e o número da linha ou  sem nenhuma informação. É possível também definir manualmente a fonte o alinhamento e o conteúdo do texto exibido. O quadro de Figuras \ref{fig:SourceEditorDMSConsole} apresenta as etapas do editor de fontes.

\vspace{9mm}
\begin{figure}[H]
	\centering
	\begin{subfigure}[t]{.5\textwidth}
		\centering
		\captionsetup{width=0.90\textwidth, font=footnotesize, textfont=bf}	
		\includegraphics[width=0.90\linewidth]{Images/SoftwareDMSConsole/FrameworkEditorNomearArquivoKeyBoard.eps}
		\caption{Tela de Nomeação do Arquivo Fonte}
		\label{fig:SourceEditorDMSConsoleA}
	\end{subfigure}%
	\begin{subfigure}[t]{.5\textwidth}
		\centering
		\captionsetup{width=0.90\textwidth, font=footnotesize, textfont=bf}	
		\includegraphics[width=0.90\linewidth]{Images/SoftwareDMSConsole/FrameworkEditorLinhaAKeyboard.eps}
		\caption{Tela de Criação de Uma Linha de Autocarro}
		\label{fig:SourceEditorDMSConsoleB}
	\end{subfigure}
	\begin{subfigure}[t]{.5\textwidth}
		\centering
		\captionsetup{width=0.90\textwidth, font=footnotesize, textfont=bf}	
		\includegraphics[width=0.90\linewidth]{Images/SoftwareDMSConsole/FrameworkEditorDestinoKeyBoard.eps}
		\caption{Tela de Criação de Destino}
		\label{fig:SourceEditorDMSConsoleC}
	\end{subfigure}%
	\begin{subfigure}[t]{.5\textwidth}
		\centering
		\captionsetup{width=0.90\textwidth, font=footnotesize, textfont=bf}	
		\includegraphics[width=0.90\linewidth]{Images/SoftwareDMSConsole/FrameworkEditorPainel.eps}
		\caption{Tela de Criação de Painel (Painéis Não Detectados)}
		\label{fig:SourceEditorDMSConsoleD}
	\end{subfigure}
	\begin{subfigure}[t]{.5\textwidth}
		\centering
		\captionsetup{width=0.90\textwidth, font=footnotesize, textfont=bf}	
		\includegraphics[width=0.90\linewidth]{Images/SoftwareDMSConsole/FrameworkEditorPainelB.eps}
		\caption{Tela de Criação de Painel}
		\label{fig:SourceEditorDMSConsoleE}
	\end{subfigure}%
	\begin{subfigure}[t]{.5\textwidth}
		\centering
		\captionsetup{width=0.90\textwidth, font=footnotesize, textfont=bf}	
		\includegraphics[width=0.90\linewidth]{Images/SoftwareDMSConsole/FrameworkEditorPagina.eps}
		\caption{Tela Criação de Página}
		\label{fig:SourceEditorDMSConsoleF}
	\end{subfigure}
	\begin{subfigure}[t]{.5\textwidth}
		\centering
		\captionsetup{width=0.90\textwidth, font=footnotesize, textfont=bf}	
		\includegraphics[width=0.90\linewidth]{Images/SoftwareDMSConsole/FrameworkEditorTexto.eps}
		\caption{Tela de Criação de Campo de Texto - Configuração}
		\label{fig:SourceEditorDMSConsoleG}
	\end{subfigure}%
	\begin{subfigure}[t]{.5\textwidth}
		\centering
		\captionsetup{width=0.90\textwidth, font=footnotesize, textfont=bf}	
		\includegraphics[width=0.90\linewidth]{Images/SoftwareDMSConsole/FrameworkEditorTextoKeyboard.eps}
		\caption{Tela de Criação de Campo de Texto}
		\label{fig:SourceEditorDMSConsoleH}
	\end{subfigure}
	\caption{Editor de Fontes DMSConsole}
	\vspace{-3.5mm}
	\caption*{Fonte: Autoria Própria}
	\label{fig:SourceEditorDMSConsole}
\end{figure}
\vspace{9mm}






